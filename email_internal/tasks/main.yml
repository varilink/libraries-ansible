- name: Deploy the email internal role
  become: yes
  block:

    - name: Install apt package(s) required by the email internal role
      apt:
        name:
          - dovecot-imapd
          - exim4
          - fetchmail
        install_recommends: no

    # Boolean values are provided as strings to mitigate this issue:
    # https://github.com/ansible/ansible/issues/25481
    # Not sure that the vtype specified has any effect?
    # Only options where a value is needed that is different to the default are
    # set.
    - name:
      debconf:
        name: exim4-config
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        # Use our own external email gateway server to send.
        # Receive via SMTP from clients on the office network.
        - question: exim4/dc_eximconfig_configtype
          value: mail sent by smarthost; received via SMTP or fetchmail
          vtype: select
        # Prefer Maildir rather than mbox for local delivery.
        - question: exim4/dc_localdelivery
          value: Maildir format in home directory
          vtype: select
        # Set the system mail name to the domain of the host.
        - question: exim4/mailname
          value: varilink.co.uk
          vtype: string
        # Listen on external interface for incoming SMTP connections.
        - question: exim4/dc_local_interfaces
          value:
          vtype: string
        # Identify of our external email gateway server.
        - question: exim4/dc_smarthost
          value: services_email-external::587
          vtype: string
        # Don't hide local mail name in outgoing mail.
        - question: exim4/hide_mailname
          value: "false"
          vtype: boolean
        # Use split configuration files.
        - question: exim4/use_split_config
          value: "true"
          vtype: boolean
        # Set the postmaster email address.
        - question: exim4/dc_postmaster
          # TODO: Parameterise
          # This email address is public knowledge however it should be
          # parameterised.
          value: david.williamson@varilink.co.uk
          vtype: string
